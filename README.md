# Ethereum-Smart-Contract-Automated-Vulnerability-Detection-and-Verification-Tool

## - Install dependencies

`yarn add --dev @nomiclabs/hardhat-ethers@npm:hardhat-deploy-ethers ethers @nomiclabs/hardhat-etherscan @nomiclabs/hardhat-waffle chai ethereum-waffle hardhat hardhat-contract-sizer hardhat-deploy hardhat-gas-reporter prettier prettier-plugin-solidity solhint solidity-coverage dotenv`

## `fetch_blockchain_data_scripts.js`

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªç©ºçš„æ•°ç»„ `contractData` æ¥ä¿å­˜è·å–åˆ°çš„æ‰€æœ‰åˆçº¦çš„ä¿¡æ¯ã€‚åœ¨æ¯ä¸ªäº¤æ˜“ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆæ£€æŸ¥äº¤æ˜“æ˜¯å¦ä¸ºåˆçº¦åˆ›å»ºäº¤æ˜“ã€‚å¦‚æœæ˜¯ï¼Œæˆ‘ä»¬ä½¿ç”¨ `ethers.ContractFactory`æ¥è§£æåˆçº¦å­—èŠ‚ç å¹¶è·å–åˆçº¦ ABIï¼Œå¹¶ä¸”é€šè¿‡`provider.getCode()`çš„æ–¹æ³•è·å¾—å­—èŠ‚ç ã€‚ç„¶åå°†æ‰€æœ‰ä¿¡æ¯æ·»åŠ åˆ° `contractData`æ•°ç»„ä¸­ã€‚
å¦‚æœäº¤æ˜“ä¸æ˜¯åˆçº¦åˆ›å»ºäº¤æ˜“ï¼Œæˆ‘ä»¬æ£€æŸ¥äº¤æ˜“ç›®æ ‡åœ°å€æ˜¯å¦ä¸ºåˆçº¦åœ°å€ï¼Œå¦‚æœæ˜¯ï¼Œæˆ‘ä»¬ä½¿ç”¨ ethers.Contract å¯¹è±¡è¿æ¥åˆ°è¯¥åœ°å€ï¼Œå¹¶ä½¿ç”¨ `interface` å±æ€§æ¥è·å–åˆçº¦ `ABI`ï¼Œç„¶åå°†æ‰€æœ‰ä¿¡æ¯æ·»åŠ åˆ° `contractData` æ•°ç»„ä¸­ã€‚

 æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨ `fs.writeFileSync` æ–¹æ³•å°† `contractData` æ•°ç»„ä¸­çš„ä¿¡æ¯ä¿å­˜åˆ°ä¸€ä¸ª JSON æ–‡ä»¶ä¸­ã€‚è¾“å‡ºæ–‡ä»¶çš„æ ¼å¼åŒ–é€‰é¡¹æ˜¯ `null, 2`ï¼Œè¿™å°†åœ¨æ–‡ä»¶ä¸­ä½¿ç”¨ä¸¤ä¸ªç©ºæ ¼æ¥ç¼©è¿›æ¯ä¸ªå¯¹è±¡çš„å±æ€§ã€‚åœ¨è¾“å‡ºæ–‡ä»¶åï¼Œç¨‹åºä¼šåœ¨æ§åˆ¶å°ä¸Šè¾“å‡ºä¸€æ¡æ¶ˆæ¯ã€‚

## 2.24

å°†`contractData.json`ä¸­çš„arrayçš„`bytecode`çš„éƒ¨åˆ†å•ç‹¬æ‹¿å‡ºæ¥ã€‚
åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆè¯»å– `contractData.json` æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ `JSON.parse` æ–¹æ³•å°†å…¶è§£æä¸ºä¸€ä¸ªå¯¹è±¡æ•°ç»„ã€‚ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨ `map` æ–¹æ³•å¯¹æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ è¿›è¡Œå¤„ç†ï¼Œæå–å…¶ä¸­çš„ `bytecode` å­—æ®µçš„å€¼ï¼Œå¹¶å°†æ‰€æœ‰å€¼å­˜å‚¨åˆ°ä¸€ä¸ªæ–°çš„æ•°ç»„ä¸­ã€‚æœ€åï¼Œæˆ‘ä»¬å°†æ–°çš„æ•°ç»„è¾“å‡ºåˆ°`typecodeData.json`ä¸­,ä¸ºä½¿ç”¨`slither`å·¥å…·çš„åšå‡†å¤‡ã€‚
ç°åœ¨éœ€è¦çŸ¥é“å¦‚ä½•ä½¿ç”¨è¿™ä¸ª`hslither`å·¥å…·ã€‚

### å®‰è£…

åˆ›å»ºpythonçš„è™šæ‹Ÿç¯å¢ƒ`gp`ï¼Œ
`conda activate gp`
`pip3 install slither-analyzer`

## 2.25

`yarn add slither-js --dev`
:imp: :imp: å‡çš„ :imp: :imp:

è¯•ç€å®‰è£…`slither`ï¼Œæ ¹æœ¬ç”¨ä¸æ¥ï¼Œåäº†ã€‚
äº†è§£äº†ä¸€ä¸‹åç»­å·¥ä½œè¦å…·ä½“æ€ä¹ˆåšæ„Ÿè§‰å¤§æ–¹å‘æ„Ÿè§‰æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯åœ¨ç»†èŠ‚éƒ¨åˆ†é—®é¢˜å¯èƒ½ä¼šæœ‰å¾ˆå¤š

## 2.26

åœ¨`powershell`ä¸Šç”¨`slither .`è¿™ä¸ªå‘½ä»¤ç«Ÿç„¶åˆè¡Œäº†ï¼Ÿè¡Œå§ã€‚

```powershell
Different versions of Solidity are used:
        - Version used: ['^0.8.0', '^0.8.7']
        - ^0.8.0 (node_modules/@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol#2)
        - ^0.8.7 (contracts/Lock.sol#3)
        - ^0.8.7 (contracts/PriceConverter.sol#2)
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#different-pragma-directives-are-used

Pragma version^0.8.0 (node_modules/@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol#2) allows old versions
Pragma version^0.8.7 (contracts/Lock.sol#3) allows old versions
Pragma version^0.8.7 (contracts/PriceConverter.sol#2) allows old versions
solc-0.8.17 is not recommended for deployment
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#incorrect-versions-of-solidity

Low level call in FundMe.withdraw() (contracts/Lock.sol#62-76):
        - (success) = i_owner.call{value: address(this).balance}() (contracts/Lock.sol#74)
Low level call in FundMe.cheaperWithdraw() (contracts/Lock.sol#78-93):
        - (success) = i_owner.call{value: address(this).balance}() (contracts/Lock.sol#91)
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#low-level-calls

Variable FundMe.i_owner (contracts/Lock.sol#22) is not in mixedCase
Variable FundMe.s_funders (contracts/Lock.sol#23) is not in mixedCase
Variable FundMe.s_addressToAmountFunded (contracts/Lock.sol#24) is not in mixedCase
Variable FundMe.s_priceFeed (contracts/Lock.sol#25) is not in mixedCase
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#conformance-to-solidity-naming-conventions

PriceConverter.getPrice(AggregatorV3Interface) (contracts/PriceConverter.sol#7-15) uses literals with too many digits:
        - uint256(answer * 10000000000) (contracts/PriceConverter.sol#14)
PriceConverter.getConversionRate(uint256,AggregatorV3Interface) (contracts/PriceConverter.sol#20-28) uses literals with too many digits:
        - ethAmountInUsd = (ethPrice * ethAmount) / 1000000000000000000 (contracts/PriceConverter.sol#25)
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#too-many-digits

FundMe.s_priceFeed (contracts/Lock.sol#25) should be immutable
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#state-variables-that-could-be-declared-immutable
. analyzed (3 contracts with 84 detectors), 14 result(s) found
```

é‚£æ¥ä¸‹æ¥æˆ‘éœ€è¦å®‰è£…`solc`çš„ç‰ˆæœ¬æ§åˆ¶å·¥å…·äº†ã€‚é¢„ç¥æ¥ä¸‹æ¥çš„æˆ‘ä¸€åˆ‡é¡ºåˆ©ã€‚ :smile:

## 2.27

å®‰è£…`Mythril`
`pip3 install mythril`

```bash
myth analyze <solidity-file>
```

Or:

```bash
myth analyze -a <contract-address>

```

## 2.28

ç”¨dockerè§£å†³äº†ï¼Œè¡Œå§ã€‚dockerçŸ³æˆ‘è¶
`docker pull mythril/myth`
å¼€å§‹åšå°æ•°æ®é›†å’Œå†™éƒ¨ç½²è„šæœ¬äº†
æƒ³ç€åšä¸ªdemoå‡ºæ¥ã€‚ç„¶åå†åšå¤§è§„æ¨¡çš„æ•°æ®æ£€æµ‹ã€‚

ä»Šå¤©åœ¨ç ”ç©¶`slither`å’Œ`mythril`è¿™ä¸¤ä¸ªæ¼æ´æ£€æµ‹å·¥å…·çš„ç”¨æ³•ã€‚*å¼€å§‹æ™ºèƒ½åˆçº¦ä»£ç å®¡è®¡(auditing)*
åŠ ä¸Šå¼€å§‹å­¦ä¹ å¦‚ä½•åˆ©ç”¨è¿™äº›æ¼æ´ã€‚

ä¾‹å¦‚é‡å…¥æ¼æ´ï¼š

```solidity
    function withdraw() external {
        uint256 balance = balances[msg.sender];
        require(balance > 0);
        (bool success, ) = msg.sender.call{value: balance}(""); // here
        require(success, "Failed to send Ether");
        balances[msg.sender] = 0;                               // here
    }
```

åœ¨ä»£ç ä¸­ï¼Œå‘é€etheråå†æ›´æ–°ä½™é¢ä¼šå¼•å‘å†²å…¥æ¼æ´(Reentrancy),å…·ä½“åŸå› æ˜¯

## 3.1

æ‘¸äº†

## 3.3

åœ¨æ–‡ä»¶ç›®å½•çš„ä»¥`T`ä¸ºå¼€å¤´çš„æ–‡ä»¶ï¼Œä»¥åè¦å°†å®ƒä»¬å†™å…¥åˆ°`hardhat`çš„`task`é‡Œé¢ã€‚

Two most common attacks:

- Reenteancy
- Oracle Manipulation

### åè®®é€‰æ‹©

`pip3 install solc-select`

### Usage

`solc-select use 0.8.7`

## åœ¨hardhatæ¡†æ¶çš„package.jsonä¸­åŠ å…¥ä»¥ä¸‹è„šæœ¬

**è¿™æ ·å°±å¯ä»¥å®ç°ä½¿ç”¨`yarn slither æ¥ä½¿ç”¨slither è¿™ä¸ªå·¥å…·ã€‚å¹¶ä¸”å¯ä»¥å¯¹å…¶è¾“å‡ºè¿›è¡Œå¤„ç†`**
`package.json`ä¸­ç¼–å†™çš„è„šæœ¬

``` json
"scripts": {
    "slither": "slither ./contracts --solc-remaps '@openzeppelin=node_modules/@openzeppelin @chainlink=node_modules/@chainlink' --exclude naming-convention,external-function,low-level-calls",
    "toolbox": "docker run -it --rm -v $PWD:/src trailofbits/eth-security-toolbox",
    "lint": "solhint 'contracts/*.sol'",
    "lint:fix": "solhint 'contracts/**/*.sol' --fix",
    "format": "prettier --write ."
  }
```

åœ¨è¿è¡Œè¿‡ç¨‹ä¸­é‡åˆ°`ArgumentTypeError: No solc version set. Run`solc-select use VERSION`or set SOLC_VERSION environment variable.`çš„é”™è¯¯

è§£å†³åŠæ³•å¦‚ä¸‹ï¼š

`set SOLC_VERSION environment variable.`

ç¼–å†™äº†ä¸€ä¸ª`solc.bat`çš„æ–‡ä»¶ï¼Œä¸€é”®ä¸‹è½½æ‰€æœ‰ç‰ˆæœ¬solidityã€‚

## 3.4

åœ¨ä½¿ç”¨dockeré‡Œé¢çš„æ™ºèƒ½åˆçº¦å·¥å…·ã€‚è¿˜åœ¨å­¦ä¹ ï¼Œé¢„è®¡æ˜å¤©å­¦å®Œå°±å¼€å§‹ç€æ‰‹æ ‡è®°æˆ‘çš„çˆ¬å‡ºæ¥çš„åˆçº¦äº†ã€‚åå¤©å¼€å§‹éƒ¨ç½²åˆçº¦ï¼Œå¼€å§‹å†™è„šæœ¬ã€‚å°½é‡è¿™ä¸€å‘¨åšå®Œæ‰€æœ‰å°å°demoçš„ä»£ç å§ã€‚ç„¶åä¸‹ä¸€å‘¨å®Œå–„+å¤§é‡æ‰¹é‡è¿›è¡Œæµ‹è¯•ã€‚ç„¶åå°±å¯ä»¥å¼€å§‹å‡†å¤‡æ¯•ä¸šè®ºæ–‡äº†ã€‚

ç†æƒ³æƒ…å†µï¼š**3æœˆå®Œå…¨æå®Œ**

----------------------

*ä½†æ„¿å¦‚æ­¤* :cry: :cry: :cry:

`trailofbits/eth-security-toolbox`æ˜¯ä¸€ä¸ªDockerå®¹å™¨ï¼Œé¢„è£…å’Œé¢„é…ç½®äº†æ‰€æœ‰`Trail of Bits`çš„ä»¥å¤ªåŠå®‰å…¨å·¥å…·ï¼ŒåŒ…æ‹¬`slitherã€echidnaã€crytic-compile`ç­‰ã€‚
æˆ‘å¯ä»¥ä»`docker hub`ä¸Šæ‹‰å–`trailofbits/eth-security-toolbox`é•œåƒï¼Œå¹¶è¿è¡Œå®ƒã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

``` powershell
docker pull trailofbits/eth-security-toolbox
docker run -it -v /path/to/your/contracts:/contracts trailofbits/eth-security-toolbox
```

è¿™ä¸ªå‘½ä»¤ä¼šå¯åŠ¨ä¸€ä¸ªäº¤äº’å¼çš„shellï¼Œ**å°†ä½ æœ¬åœ°çš„åˆçº¦ç›®å½•æ˜ å°„åˆ°å®¹å™¨é‡Œçš„/contractsç›®å½•ã€‚**

åœ¨å®¹å™¨é‡Œï¼Œä½ å¯ä»¥ä½¿ç”¨ä»»ä½•`Trail of Bits`çš„å·¥å…·æ¥æ£€æµ‹ä½ çš„solæ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨slitheræ¥åˆ†æVaultFuzzTest.solæ–‡ä»¶ï¼š
`slither /contracts/test/fuzzing/VaultFuzzTest.sol --config /contracts/test/fuzzing/config.yaml`

## Fuzzing test

with tool **Echidna**

```powershell
Analyzing contract: /src/test/fuzzing/VaultFuzzTest.sol:VaultFuzzTest
echidna_test_find_password: failed!ğŸ’¥
  Call sequence:
    unlock("123asd123\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL")



Unique instructions: 154
Unique codehashes: 1
Corpus size: 1
Seed: -6925906297868386582
```

## 3.5

ä»Šå¤©æ–°å¼€äº†ä¸€ä¸ª`T_LableTheContracts.js`,ç›®çš„æ˜¯ç”¨æ¥ç»™æˆ‘fetchåˆ°çš„åˆçº¦çš„å­—èŠ‚ç æ·»ä¸Šæ ‡ç­¾ã€‚
dockeråœ°å‘½ä»¤æ€»æ˜¯å‡ºé”™ï¼Œè¿˜åœ¨è°ƒè¯•ã€‚å¯èƒ½è¦æ¢åˆ°linuxç³»ç»Ÿä¸Šã€‚

## 3.6

```bash
æ‰§è¡Œå‡ºé”™: Error: Command failed: docker run -v /mnt/d/Code/JS-Solidity/Graduation_Project/contract_data:/data:rw trailofbits/eth-security-toolbox slither /data
/home/ethsec/.local/bin/slither: line 4: import: command not found
/home/ethsec/.local/bin/slither: line 5: import: command not found
/home/ethsec/.local/bin/slither: line 7: from: command not found
/home/ethsec/.local/bin/slither: slither: line 10: syntax error near unexpected token `('
/home/ethsec/.local/bin/slither: slither: line 10: `    sys.argv[0] = re.sub(r'(-script\.pyw?|\.exe)?$', '', sys.argv[0])'
```

è¿™ä¸ªé”™è¯¯ä¿¡æ¯è¡¨æ˜ä½ åœ¨è¿è¡Œ `slither` å‘½ä»¤æ—¶å‡ºç°äº†é—®é¢˜ã€‚çœ‹èµ·æ¥åƒæ˜¯ `slither` è„šæœ¬çš„ç¬¬ 4 è¡Œå’Œç¬¬ 5 è¡Œä¸­çš„ `import` å‘½ä»¤æ²¡æœ‰è¢«è¯†åˆ«ã€‚è¿™å¯èƒ½æ˜¯ç”±äºä½ çš„ç¯å¢ƒä¸­ç¼ºå°‘æŸäº›ä¾èµ–æˆ–é…ç½®ä¸æ­£ç¡®å¯¼è‡´çš„ã€‚

ä½ å¯ä»¥å°è¯•æ£€æŸ¥ä½ çš„ç¯å¢ƒé…ç½®ï¼Œç¡®ä¿æ‰€æœ‰å¿…è¦çš„ä¾èµ–éƒ½å·²å®‰è£…å¹¶æ­£ç¡®é…ç½®ã€‚å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œå»ºè®®æŸ¥é˜… `slither` çš„æ–‡æ¡£ä»¥è·å–æ›´å¤šå¸®åŠ©ã€‚
