# Ethereum-Smart-Contract-Automated-Vulnerability-Detection-and-Verification-Tool

## - Install dependencies

`yarn add --dev @nomiclabs/hardhat-ethers@npm:hardhat-deploy-ethers ethers @nomiclabs/hardhat-etherscan @nomiclabs/hardhat-waffle chai ethereum-waffle hardhat hardhat-contract-sizer hardhat-deploy hardhat-gas-reporter prettier prettier-plugin-solidity solhint solidity-coverage dotenv`

## `fetch_blockchain_data_scripts.js`

在这个示例中，我们使用了一个空的数组 `contractData` 来保存获取到的所有合约的信息。在每个交易中，我们首先检查交易是否为合约创建交易。如果是，我们使用 `ethers.ContractFactory`来解析合约字节码并获取合约 ABI，并且通过`provider.getCode()`的方法获得字节码。然后将所有信息添加到 `contractData`数组中。
如果交易不是合约创建交易，我们检查交易目标地址是否为合约地址，如果是，我们使用 ethers.Contract 对象连接到该地址，并使用 `interface` 属性来获取合约 `ABI`，然后将所有信息添加到 `contractData` 数组中。

最后，我们使用 `fs.writeFileSync` 方法将 `contractData` 数组中的信息保存到一个 JSON 文件中。输出文件的格式化选项是 `null, 2`，这将在文件中使用两个空格来缩进每个对象的属性。在输出文件后，程序会在控制台上输出一条消息。

## 2.24

将`contractData.json`中的 array 的`bytecode`的部分单独拿出来。
在这个例子中，我们首先读取 `contractData.json` 文件，并使用 `JSON.parse` 方法将其解析为一个对象数组。然后，我们使用 `map` 方法对数组中的每个元素进行处理，提取其中的 `bytecode` 字段的值，并将所有值存储到一个新的数组中。最后，我们将新的数组输出到`typecodeData.json`中,为使用`slither`工具的做准备。
现在需要知道如何使用这个`hslither`工具。

### 安装

创建 python 的虚拟环境`gp`，
`conda activate gp`
`pip3 install slither-analyzer`

## 2.25

`yarn add slither-js --dev`
:imp: :imp: 假的 :imp: :imp:

试着安装`slither`，根本用不来，吐了。
了解了一下后续工作要具体怎么做感觉大方向感觉没什么问题，但是在细节部分问题可能会有很多

## 2.26

在`powershell`上用`slither .`这个命令竟然又行了？行吧。

```powershell
Different versions of Solidity are used:
        - Version used: ['^0.8.0', '^0.8.7']
        - ^0.8.0 (node_modules/@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol#2)
        - ^0.8.7 (contracts/Lock.sol#3)
        - ^0.8.7 (contracts/PriceConverter.sol#2)
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#different-pragma-directives-are-used

Pragma version^0.8.0 (node_modules/@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol#2) allows old versions
Pragma version^0.8.7 (contracts/Lock.sol#3) allows old versions
Pragma version^0.8.7 (contracts/PriceConverter.sol#2) allows old versions
solc-0.8.17 is not recommended for deployment
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#incorrect-versions-of-solidity

Low level call in FundMe.withdraw() (contracts/Lock.sol#62-76):
        - (success) = i_owner.call{value: address(this).balance}() (contracts/Lock.sol#74)
Low level call in FundMe.cheaperWithdraw() (contracts/Lock.sol#78-93):
        - (success) = i_owner.call{value: address(this).balance}() (contracts/Lock.sol#91)
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#low-level-calls

Variable FundMe.i_owner (contracts/Lock.sol#22) is not in mixedCase
Variable FundMe.s_funders (contracts/Lock.sol#23) is not in mixedCase
Variable FundMe.s_addressToAmountFunded (contracts/Lock.sol#24) is not in mixedCase
Variable FundMe.s_priceFeed (contracts/Lock.sol#25) is not in mixedCase
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#conformance-to-solidity-naming-conventions

PriceConverter.getPrice(AggregatorV3Interface) (contracts/PriceConverter.sol#7-15) uses literals with too many digits:
        - uint256(answer * 10000000000) (contracts/PriceConverter.sol#14)
PriceConverter.getConversionRate(uint256,AggregatorV3Interface) (contracts/PriceConverter.sol#20-28) uses literals with too many digits:
        - ethAmountInUsd = (ethPrice * ethAmount) / 1000000000000000000 (contracts/PriceConverter.sol#25)
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#too-many-digits

FundMe.s_priceFeed (contracts/Lock.sol#25) should be immutable
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#state-variables-that-could-be-declared-immutable
. analyzed (3 contracts with 84 detectors), 14 result(s) found
```

那接下来我需要安装`solc`的版本控制工具了。预祝接下来的我一切顺利。 :smile:

## 2.27

安装`Mythril`
`pip3 install mythril`

```bash
myth analyze <solidity-file>
```

Or:

```bash
myth analyze -a <contract-address>

```

## 2.28

用 docker 解决了，行吧。docker 石我蝶
`docker pull mythril/myth`
开始做小数据集和写部署脚本了
想着做个 demo 出来。然后再做大规模的数据检测。

今天在研究`slither`和`mythril`这两个漏洞检测工具的用法。_开始智能合约代码审计(auditing)_
加上开始学习如何利用这些漏洞。

例如重入漏洞：

```solidity
function withdraw() external {
    uint256 balance = balances[msg.sender];
    require(balance > 0);
    (bool success, ) = msg.sender.call{ value: balance }(""); // here
    require(success, "Failed to send Ether");
    balances[msg.sender] = 0; // here
}
```

在代码中，发送 ether 后再更新余额会引发冲入漏洞(Reentrancy),具体原因是

## 3.1

摸了

## 3.3

在文件目录的以`T`为开头的文件，以后要将它们写入到`hardhat`的`task`里面。

Two most common attacks:

- Reenteancy
- Oracle Manipulation

### 协议选择

`pip3 install solc-select`

### Usage

`solc-select use 0.8.7`

## 在 hardhat 框架的 package.json 中加入以下脚本

**这样就可以实现使用`yarn slither 来使用slither 这个工具。并且可以对其输出进行处理`**
`package.json`中编写的脚本

```json
"scripts": {
    "slither": "slither ./contracts --solc-remaps '@openzeppelin=node_modules/@openzeppelin @chainlink=node_modules/@chainlink' --exclude naming-convention,external-function,low-level-calls",
    "toolbox": "docker run -it --rm -v $PWD:/src trailofbits/eth-security-toolbox",
    "lint": "solhint 'contracts/*.sol'",
    "lint:fix": "solhint 'contracts/**/*.sol' --fix",
    "format": "prettier --write ."
  }
```

在运行过程中遇到`ArgumentTypeError: No solc version set. Run`solc-select use VERSION`or set SOLC_VERSION environment variable.`的错误

解决办法如下：

`set SOLC_VERSION environment variable.`

编写了一个`solc.bat`的文件，一键下载所有版本 solidity。

## 3.4

在使用 docker 里面的智能合约工具。还在学习，预计明天学完就开始着手标记我的爬出来的合约了。后天开始部署合约，开始写脚本。尽量这一周做完所有小小 demo 的代码吧。然后下一周完善+大量批量进行测试。然后就可以开始准备毕业论文了。

理想情况：**3 月完全搞完**

---

_但愿如此_ :cry: :cry: :cry:

`trailofbits/eth-security-toolbox`是一个 Docker 容器，预装和预配置了所有`Trail of Bits`的以太坊安全工具，包括`slither、echidna、crytic-compile`等。
我可以从`docker hub`上拉取`trailofbits/eth-security-toolbox`镜像，并运行它。例如，你可以使用以下命令：

```powershell
docker pull trailofbits/eth-security-toolbox
docker run -it -v /path/to/your/contracts:/contracts trailofbits/eth-security-toolbox
```

这个命令会启动一个交互式的 shell，**将你本地的合约目录映射到容器里的/contracts 目录。**

在容器里，你可以使用任何`Trail of Bits`的工具来检测你的 sol 文件。例如，你可以使用 slither 来分析 VaultFuzzTest.sol 文件：
`slither /contracts/test/fuzzing/VaultFuzzTest.sol --config /contracts/test/fuzzing/config.yaml`

## Fuzzing test

with tool **Echidna**

```powershell
Analyzing contract: /src/test/fuzzing/VaultFuzzTest.sol:VaultFuzzTest
echidna_test_find_password: failed!💥
  Call sequence:
    unlock("123asd123\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL")



Unique instructions: 154
Unique codehashes: 1
Corpus size: 1
Seed: -6925906297868386582
```

## 3.5

今天新开了一个`T_LableTheContracts.js`,目的是用来给我 fetch 到的合约的字节码添上标签。
docker 地命令总是出错，还在调试。可能要换到 linux 系统上。

## 3.6

Use our prebuilt Docker container to quickly install and run the toolkit:

```powershell
docker pull trailofbits/eth-security-toolbox
docker run -it trailofbits/eth-security-toolbox
```

```bash
执行出错: Error: Command failed: docker run -v /mnt/d/Code/JS-Solidity/Graduation_Project/contract_data:/data:rw trailofbits/eth-security-toolbox slither /data
/home/ethsec/.local/bin/slither: line 4: import: command not found
/home/ethsec/.local/bin/slither: line 5: import: command not found
/home/ethsec/.local/bin/slither: line 7: from: command not found
/home/ethsec/.local/bin/slither: slither: line 10: syntax error near unexpected token `('
/home/ethsec/.local/bin/slither: slither: line 10: `    sys.argv[0] = re.sub(r'(-script\.pyw?|\.exe)?$', '', sys.argv[0])'
```

这个错误信息表明你在运行 `slither` 命令时出现了问题。看起来像是 `slither` 脚本的第 4 行和第 5 行中的 `import` 命令没有被识别。这可能是由于你的环境中缺少某些依赖或配置不正确导致的。

你可以尝试检查你的环境配置，确保所有必要的依赖都已安装并正确配置。如果问题仍然存在，建议查阅 `slither` 的文档以获取更多帮助。

## 3.7

`docker pull python`

## 3.8

这个文件中除了 abi 以外，还可以看到这个 bytecode，将其和 transaction 的 data 字段进行比对，会发现一模一样。

### 关于 bytecode 和 deployedBytecode 的区别

其实`deployedBytecode`是明显要比`bytecode`短的，这是因为`bytecode`里包含了一些`constructor`操作，以及合约收款验证等预置操作，这些预置操作只有在部署合约的时候才会运行一次，之后再也不会运行，所以`Transaction`中的`data`是`bytecode`，而以太坊节点保存的字节码，则是`deployedBytecode`。

## 3.10

昨天修改了我 py 的代码。然后就可以开始使用工具进行打标签活动了。来吧，用 js 来写。

## SLITHER

```powershell
target can be:
        - file.sol // a Solidity file
        - project_directory // a project directory. See https://github.com/crytic/crytic-compile/#crytic-compile for the supported platforms
        - 0x.. // a contract on mainnet
        - NETWORK:0x.. // a contract on a different network. Supported networks: mainet,optim,ropsten,kovan,rinkeby,goerli,tobalaba,bsc,testnet.bsc,arbi,testnet.arbi,poly,mumbai,avax,testnet.avax,ftm

For usage information, see https://github.com/crytic/slither/wiki/Usage

optional arguments:
  -h, --help            show this help message and exit
  --version             displays the current version

Compile options:
  --compile-force-framework COMPILE_FORCE_FRAMEWORK
                        Force the compile to a given framework (solc,truffle,embark,dapp,etherlime,etherscan,vyper,waffle,brownie,solc-json,buidler,hardhat,foundry,standard,archive)
  --compile-remove-metadata
                        Remove the metadata from the bytecodes
  --compile-custom-build COMPILE_CUSTOM_BUILD
                        Replace platform specific build command
  --ignore-compile      Do not run compile of any platform
  --skip-clean          Do not attempt to clean before compiling with a platform

Solc options:
  --solc SOLC           solc path
  --solc-remaps SOLC_REMAPS
                        Add remapping
  --solc-args SOLC_ARGS
                        Add custom solc arguments. Example: --solc-args "--allow-path /tmp --evm-version byzantium".
  --solc-disable-warnings
                        Disable solc warnings
  --solc-working-dir SOLC_WORKING_DIR
                        Change the default working directory
  --solc-solcs-select SOLC_SOLCS_SELECT
                        Specify different solc version to try (env config). Depends on solc-select
  --solc-solcs-bin SOLC_SOLCS_BIN
                        Specify different solc version to try (path config). Example: --solc-solcs-bin solc-0.4.24,solc-0.5.3
  --solc-standard-json  Compile all specified targets in a single compilation using solc standard json
  --solc-force-legacy-json
                        Force the solc compiler to use the legacy json ast format over the compact json ast format

Truffle options:
  --truffle-ignore-compile
                        Do not run truffle compile
  --truffle-build-directory TRUFFLE_BUILD_DIRECTORY
                        Use an alternative truffle build directory
  --truffle-version TRUFFLE_VERSION
                        Use a local Truffle version (with npx)
  --truffle-overwrite-config
                        Use a simplified version of truffle-config.js for compilation
  --truffle-overwrite-version TRUFFLE_OVERWRITE_VERSION
                        Overwrite solc version in truffle-config.js (only if --truffle-overwrite-config)

Embark options:
  --embark-ignore-compile
                        Do not run embark build
  --embark-overwrite-config
                        Install @trailofbits/embark-contract-export and add it to embark.json

Brownie options:
  --brownie-ignore-compile
                        Do not run brownie compile

Dapp options:
  --dapp-ignore-compile
                        Do not run dapp build

Etherlime options:
  --etherlime-ignore-compile
                        Do not run etherlime compile
  --etherlime-compile-arguments
                        Add arbitrary arguments to etherlime compile (note: [dir] is the the directory provided to crytic-compile)

Etherscan options:
  --etherscan-only-source-code
                        Only compile if the source code is available.
  --etherscan-only-bytecode
                        Only looks for bytecode.
  --etherscan-apikey ETHERSCAN_API_KEY
                        Etherscan API key.
  --arbiscan-apikey ARBISCAN_API_KEY
                        Etherscan API key.
  --polygonscan-apikey POLYGONSCAN_API_KEY
                        Etherscan API key.
  --test-polygonscan-apikey TEST_POLYGONSCAN_API_KEY
                        Etherscan API key.
  --avax-apikey AVAX_API_KEY
                        Etherscan API key.
  --ftmscan-apikey FTMSCAN_API_KEY
                        Etherscan API key.
  --bscan-apikey BSCAN_API_KEY
                        Etherscan API key.
  --optim-apikey OPTIM_API_KEY
                        Optimistic API key.
  --etherscan-export-directory ETHERSCAN_EXPORT_DIR
                        Directory in which to save the analyzed contracts.

Waffle options:
  --waffle-ignore-compile
                        Do not run waffle compile
  --waffle-config-file WAFFLE_CONFIG_FILE
                        Provide a waffle config file

NPX options:
  --npx-disable         Do not use npx

Buidler options:
  --buidler-ignore-compile
                        Do not run buidler compile
  --buidler-cache-directory BUIDLER_CACHE_DIRECTORY
                        Use an alternative buidler cache directory (default ./cache)
  --buidler-skip-directory-name-fix
                        Disable directory name fix (see https://github.com/crytic/crytic-compile/issues/116)

Hardhat options:
  --hardhat-ignore-compile
                        Do not run hardhat compile
  --hardhat-cache-directory HARDHAT_CACHE_DIRECTORY
                        Use an alternative hardhat cache directory (default ./cache)
  --hardhat-artifacts-directory HARDHAT_ARTIFACTS_DIRECTORY
                        Use an alternative hardhat artifacts directory (default ./artifacts)

Foundry options:
  --foundry-ignore-compile
                        Do not run foundry compile
  --foundry-out-directory FOUNDRY_OUT_DIRECTORY
                        Use an alternative out directory (default: out)

Detectors:
  --detect DETECTORS_TO_RUN
                        Comma-separated list of detectors, defaults to all, available detectors: abiencoderv2-array, arbitrary-send-erc20, arbitrary-send-erc20-permit, arbitrary-send-eth, array-by-
                        reference, controlled-array-length, assembly, assert-state-change, backdoor, weak-prng, boolean-cst, boolean-equal, shadowing-builtin, codex, constant-function-asm, constant-
                        function-state, pragma, controlled-delegatecall, costly-loop, constable-states, immutable-states, dead-code, delegatecall-loop, deprecated-standards, divide-before-multiply,
                        domain-separator-collision, enum-conversion, external-function, function-init-state, erc20-interface, erc721-interface, solc-version, incorrect-equality, incorrect-unary,
                        shadowing-local, locked-ether, low-level-calls, mapping-deletion, events-access, events-maths, missing-inheritance, missing-zero-check, incorrect-modifier, msg-value-loop, calls-
                        loop, multiple-constructors, name-reused, naming-convention, variable-scope, protected-vars, public-mappings-nested, redundant-statements, reentrancy-benign, reentrancy-eth,
                        reentrancy-events, reentrancy-unlimited-gas, reentrancy-no-eth, reused-constructor, rtlo, shadowing-abstract, incorrect-shift, similar-names, shadowing-state, storage-array,
                        suicidal, timestamp, too-many-digits, tx-origin, tautology, unchecked-lowlevel, unchecked-send, unchecked-transfer, unimplemented-functions, erc20-indexed, uninitialized-fptr-cst,
                        uninitialized-local, uninitialized-state, uninitialized-storage, unprotected-upgrade, unused-return, unused-state, var-read-using-this, void-cst, write-after-write
  --list-detectors      List available detectors
  --exclude DETECTORS_TO_EXCLUDE
                        Comma-separated list of detectors that should be excluded
  --exclude-dependencies
                        Exclude results that are only related to dependencies
  --exclude-optimization
                        Exclude optimization analyses
  --exclude-informational
                        Exclude informational impact analyses
  --exclude-low         Exclude low impact analyses
  --exclude-medium      Exclude medium impact analyses
  --exclude-high        Exclude high impact analyses
  --fail-pedantic       Return the number of findings in the exit code
  --no-fail-pedantic    Do not return the number of findings in the exit code. Opposite of --fail-pedantic
  --fail-low            Fail if low or greater impact finding is detected
  --fail-medium         Fail if medium or greater impact finding is detected
  --fail-high           Fail if high impact finding is detected
  --show-ignored-findings
                        Show all the findings

Printers:
  --print PRINTERS_TO_RUN
                        Comma-separated list of contract information printers, available printers: cfg, constructor-calls, contract-summary, data-dependency, declaration, dominator, echidna, function-id,
                        function-summary, modifiers, call-graph, evm, human-summary, inheritance, inheritance-graph, slithir, slithir-ssa, pausable, vars-and-auth, require, variable-order
  --list-printers       List available printers

Checklist (consider using https://github.com/crytic/slither-action):
  --checklist           Generate a markdown page with the detector results
  --checklist-limit CHECKLIST_LIMIT
                        Limite the number of results per detector in the markdown file
  --markdown-root MARKDOWN_ROOT
                        URL for markdown generation

Additional options:
  --json JSON           Export the results as a JSON file ("--json -" to export to stdout)
  --sarif SARIF         Export the results as a SARIF JSON file ("--sarif -" to export to stdout)
  --json-types JSON_TYPES
                        Comma-separated list of result types to output to JSON, defaults to detectors,printers. Available types: compilations,console,detectors,printers,list-detectors,list-printers
  --zip ZIP             Export the results as a zipped JSON file
  --zip-type ZIP_TYPE   Zip compression type. One of lzma,stored,deflated,bzip2. Default lzma
  --disable-color       Disable output colorization
  --filter-paths FILTER_PATHS
                        Comma-separated list of paths for which results will be excluded
  --triage-mode         Run triage mode (save results in slither.db.json)
  --config-file CONFIG_FILE
                        Provide a config file (default: slither.config.json)
  --change-line-prefix CHANGE_LINE_PREFIX
                        Change the line prefix (default #) for the displayed source codes (i.e. file.sol#1).
  --solc-ast            Provide the contract as a json AST
  --generate-patches    Generate patches (json output only)
  --no-fail             Do not fail in case of parsing (echidna mode only)

Codex (https://beta.openai.com/docs/guides/code):
  --codex               Enable codex (require an OpenAI API Key)
  --codex-log           Log codex queries (in crytic_export/codex/)
  --codex-contracts CODEX_CONTRACTS
                        Comma separated list of contracts to submit to OpenAI Codex
  --codex-model CODEX_MODEL
                        Name of the Codex model to use (affects pricing). Defaults to 'text-davinci-003'
  --codex-temperature CODEX_TEMPERATURE
                        Temperature to use with Codex. Lower number indicates a more precise answer while higher numbers return more creative answers. Defaults to 0
  --codex-max-tokens CODEX_MAX_TOKENS
                        Maximum amount of tokens to use on the response. This number plus the size of the prompt can be no larger than the limit (4097 for text-davinci-003)
```

接下来是想办法处理软件输出结果（根据上面的 slither -h 的提示），然后对漏洞类型进行分类，然后给每个合约加上标签。
（希望能遇到几个有漏洞的而且可以成功重现漏洞的合约，感觉希望不大）

## 3.15

发烧，估计是甲流，室友传给我的。今天才有点精神。赶紧毕业换个环境，感觉室友都有些拖累我。
