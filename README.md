# Ethereum-Smart-Contract-Automated-Vulnerability-Detection-and-Verification-Tool

## - Install dependencies

`yarn add --dev @nomiclabs/hardhat-ethers@npm:hardhat-deploy-ethers ethers @nomiclabs/hardhat-etherscan @nomiclabs/hardhat-waffle chai ethereum-waffle hardhat hardhat-contract-sizer hardhat-deploy hardhat-gas-reporter prettier prettier-plugin-solidity solhint solidity-coverage dotenv`

## `fetch_blockchain_data_scripts.js`

在这个示例中，我们使用了一个空的数组 `contractData` 来保存获取到的所有合约的信息。在每个交易中，我们首先检查交易是否为合约创建交易。如果是，我们使用 `ethers.ContractFactory`来解析合约字节码并获取合约 ABI，并且通过`provider.getCode()`的方法获得字节码。然后将所有信息添加到 `contractData`数组中。
如果交易不是合约创建交易，我们检查交易目标地址是否为合约地址，如果是，我们使用 ethers.Contract 对象连接到该地址，并使用 `interface` 属性来获取合约 `ABI`，然后将所有信息添加到 `contractData` 数组中。

 最后，我们使用 `fs.writeFileSync` 方法将 `contractData` 数组中的信息保存到一个 JSON 文件中。输出文件的格式化选项是 `null, 2`，这将在文件中使用两个空格来缩进每个对象的属性。在输出文件后，程序会在控制台上输出一条消息。

## 2.24

将`contractData.json`中的array的`bytecode`的部分单独拿出来。
在这个例子中，我们首先读取 `contractData.json` 文件，并使用 `JSON.parse` 方法将其解析为一个对象数组。然后，我们使用 `map` 方法对数组中的每个元素进行处理，提取其中的 `bytecode` 字段的值，并将所有值存储到一个新的数组中。最后，我们将新的数组输出到`typecodeData.json`中,为使用`slither`工具的做准备。
现在需要知道如何使用这个`hslither`工具。

### 安装

创建python的虚拟环境`gp`，
`conda activate gp`
`pip3 install slither-analyzer`

## 2.25

`yarn add slither-js --dev`
:imp: :imp: 假的 :imp: :imp:

试着安装`slither`，根本用不来，吐了。
了解了一下后续工作要具体怎么做感觉大方向感觉没什么问题，但是在细节部分问题可能会有很多

## 2.26

在`powershell`上用`slither .`这个命令竟然又行了？行吧。

```powershell
Different versions of Solidity are used:
        - Version used: ['^0.8.0', '^0.8.7']
        - ^0.8.0 (node_modules/@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol#2)
        - ^0.8.7 (contracts/Lock.sol#3)
        - ^0.8.7 (contracts/PriceConverter.sol#2)
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#different-pragma-directives-are-used

Pragma version^0.8.0 (node_modules/@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol#2) allows old versions
Pragma version^0.8.7 (contracts/Lock.sol#3) allows old versions
Pragma version^0.8.7 (contracts/PriceConverter.sol#2) allows old versions
solc-0.8.17 is not recommended for deployment
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#incorrect-versions-of-solidity

Low level call in FundMe.withdraw() (contracts/Lock.sol#62-76):
        - (success) = i_owner.call{value: address(this).balance}() (contracts/Lock.sol#74)
Low level call in FundMe.cheaperWithdraw() (contracts/Lock.sol#78-93):
        - (success) = i_owner.call{value: address(this).balance}() (contracts/Lock.sol#91)
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#low-level-calls

Variable FundMe.i_owner (contracts/Lock.sol#22) is not in mixedCase
Variable FundMe.s_funders (contracts/Lock.sol#23) is not in mixedCase
Variable FundMe.s_addressToAmountFunded (contracts/Lock.sol#24) is not in mixedCase
Variable FundMe.s_priceFeed (contracts/Lock.sol#25) is not in mixedCase
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#conformance-to-solidity-naming-conventions

PriceConverter.getPrice(AggregatorV3Interface) (contracts/PriceConverter.sol#7-15) uses literals with too many digits:
        - uint256(answer * 10000000000) (contracts/PriceConverter.sol#14)
PriceConverter.getConversionRate(uint256,AggregatorV3Interface) (contracts/PriceConverter.sol#20-28) uses literals with too many digits:
        - ethAmountInUsd = (ethPrice * ethAmount) / 1000000000000000000 (contracts/PriceConverter.sol#25)
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#too-many-digits

FundMe.s_priceFeed (contracts/Lock.sol#25) should be immutable
Reference: https://github.com/crytic/slither/wiki/Detector-Documentation#state-variables-that-could-be-declared-immutable
. analyzed (3 contracts with 84 detectors), 14 result(s) found
```

那接下来我需要安装`solc`的版本控制工具了。预祝接下来的我一切顺利。 :smile:

## 2.27

安装`Mythril`
`pip3 install mythril`

```bash
myth analyze <solidity-file>
```

Or:

```bash
myth analyze -a <contract-address>

```

## 2.28

用docker解决了，行吧。docker石我蝶
`docker pull mythril/myth`
开始做小数据集和写部署脚本了
想着做个demo出来。然后再做大规模的数据检测。

今天在研究`slither`和`mythril`这两个漏洞检测工具的用法。*开始智能合约代码审计(auditing)*
加上开始学习如何利用这些漏洞。

例如重入漏洞：

```solidity
    function withdraw() external {
        uint256 balance = balances[msg.sender];
        require(balance > 0);
        (bool success, ) = msg.sender.call{value: balance}(""); // here
        require(success, "Failed to send Ether");
        balances[msg.sender] = 0;                               // here
    }
```

在代码中，发送ether后再更新余额会引发冲入漏洞(Reentrancy),具体原因是

## 3.1

摸了

## 3.3

在文件目录的以`T`为开头的文件，以后要将它们写入到`hardhat`的`task`里面。

Two most common attacks:

- Reenteancy
- Oracle Manipulation

### 协议选择

`pip3 install solc-select`

### Usage

`solc-select use 0.8.7`

## 在hardhat框架的package.json中加入以下脚本

**这样就可以实现使用`yarn slither 来使用slither 这个工具。并且可以对其输出进行处理`**
`package.json`中编写的脚本

``` json
"scripts": {
    "slither": "slither ./contracts --solc-remaps '@openzeppelin=node_modules/@openzeppelin @chainlink=node_modules/@chainlink' --exclude naming-convention,external-function,low-level-calls",
    "toolbox": "docker run -it --rm -v $PWD:/src trailofbits/eth-security-toolbox",
    "lint": "solhint 'contracts/*.sol'",
    "lint:fix": "solhint 'contracts/**/*.sol' --fix",
    "format": "prettier --write ."
  }
```

在运行过程中遇到`ArgumentTypeError: No solc version set. Run`solc-select use VERSION`or set SOLC_VERSION environment variable.`的错误

解决办法如下：

`set SOLC_VERSION environment variable.`

编写了一个`solc.bat`的文件，一键下载所有版本solidity。

## 3.4

在使用docker里面的智能合约工具。还在学习，预计明天学完就开始着手标记我的爬出来的合约了。后天开始部署合约，开始写脚本。尽量这一周做完所有小小demo的代码吧。然后下一周完善+大量批量进行测试。然后就可以开始准备毕业论文了。

理想情况：**3月完全搞完**

----------------------

*但愿如此* :cry: :cry: :cry:

`trailofbits/eth-security-toolbox`是一个Docker容器，预装和预配置了所有`Trail of Bits`的以太坊安全工具，包括`slither、echidna、crytic-compile`等。
我可以从`docker hub`上拉取`trailofbits/eth-security-toolbox`镜像，并运行它。例如，你可以使用以下命令：

``` powershell
docker pull trailofbits/eth-security-toolbox
docker run -it -v /path/to/your/contracts:/contracts trailofbits/eth-security-toolbox
```

这个命令会启动一个交互式的shell，**将你本地的合约目录映射到容器里的/contracts目录。**

在容器里，你可以使用任何`Trail of Bits`的工具来检测你的sol文件。例如，你可以使用slither来分析VaultFuzzTest.sol文件：
`slither /contracts/test/fuzzing/VaultFuzzTest.sol --config /contracts/test/fuzzing/config.yaml`

## Fuzzing test

with tool **Echidna**

```powershell
Analyzing contract: /src/test/fuzzing/VaultFuzzTest.sol:VaultFuzzTest
echidna_test_find_password: failed!💥
  Call sequence:
    unlock("123asd123\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL\NUL")



Unique instructions: 154
Unique codehashes: 1
Corpus size: 1
Seed: -6925906297868386582
```

## 3.5

今天新开了一个`T_LableTheContracts.js`,目的是用来给我fetch到的合约的字节码添上标签。
docker地命令总是出错，还在调试。可能要换到linux系统上。

## 3.6

```bash
执行出错: Error: Command failed: docker run -v /mnt/d/Code/JS-Solidity/Graduation_Project/contract_data:/data:rw trailofbits/eth-security-toolbox slither /data
/home/ethsec/.local/bin/slither: line 4: import: command not found
/home/ethsec/.local/bin/slither: line 5: import: command not found
/home/ethsec/.local/bin/slither: line 7: from: command not found
/home/ethsec/.local/bin/slither: slither: line 10: syntax error near unexpected token `('
/home/ethsec/.local/bin/slither: slither: line 10: `    sys.argv[0] = re.sub(r'(-script\.pyw?|\.exe)?$', '', sys.argv[0])'
```

这个错误信息表明你在运行 `slither` 命令时出现了问题。看起来像是 `slither` 脚本的第 4 行和第 5 行中的 `import` 命令没有被识别。这可能是由于你的环境中缺少某些依赖或配置不正确导致的。

你可以尝试检查你的环境配置，确保所有必要的依赖都已安装并正确配置。如果问题仍然存在，建议查阅 `slither` 的文档以获取更多帮助。
